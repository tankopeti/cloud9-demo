-- Cloud9.2 – Telepítési lépések (DB + Identity seed + első belépés)
-- 0) Előfeltételek

-- .NET 8 SDK telepítve

-- SQL Server elérhető (helyi Docker vagy külön instance)

-- Projekt futtatható dotnet run-nal vagy Visual Studio-val

-- 1) Konfiguráció (connection string + titkok)
-- 1.1. Connection string beállítása

-- appsettings.json-ban vagy környezeti változóban legyen:

-- "ConnectionStrings": {
--   "DefaultConnection": "Server=127.0.0.1,1433;Database=c9Nyugalom;User Id=sa;Password=...;TrustServerCertificate=True;"
-- }


-- Ajánlás: jelszavak/tokek ne legyenek appsettings.json-ban:

-- DEV: dotnet user-secrets

-- PROD: environment variables / vault

-- 1.2. (Opcionális) Seed jelszavak konfigurálása

-- Ha nem akarsz defaultot:

-- "SeedAdminPasswords": {
--   "SuperAdmin": "ErosJelszo!123",
--   "Admin": "ErosJelszo!123"
-- }



-- Ha nincs megadva, a fallback (alapértelmezett!!!!!):

-- SuperAdmin: SuperAdmin@123

-- Admin: Admin@123



-- 2) Adatbázis létrehozása
-- 2.1. DB létrehozása

-- Hozd létre a DB-t c9Nyugalom néven (pl. SSMS / Azure Data Studio / script):

-- CREATE DATABASE c9Nyugalom;


-- Megjegyzés: korábban DBCC CLONEDATABASE-et használtunk “üres klón” készítésére, de telepítési metódushoz jobb a migrációból építkezés. A lényeg: legyen üres DB, amire ráfutnak a migrációk.

-- 3) Migrációk futtatása (schema felépítése)

-- A Program.cs-ben be van téve az indításkori migráció:

-- await context.Database.MigrateAsync();


-- Ezért telepítéskor elég az app indítása — felépíti a sémát.

-- Alternatíva (CLI):

-- dotnet ef database update


-- Ellenőrzés SQL-ben:

-- SELECT * FROM dbo.__EFMigrationsHistory;


-- Ha van benne sor, a migrációk futottak.

-- 4) Identity seed (Role-ok + első admin userek létrehozása)

-- A Program.cs-ben a seeding az app indulásakor lefut:

-- 4.1. Role-ok létrehozása (idempotens)

-- SuperAdmin

-- Admin

-- Ellenőrzés:

-- SELECT * FROM dbo.AspNetRoles;

-- 4.2. Felhasználók létrehozása (idempotens)

-- superadmin@example.com

-- admin@example.com

-- Ellenőrzés:

-- SELECT Email, UserName, PasswordHash FROM dbo.AspNetUsers;


-- Fontos: SQL-ből ne hozzunk létre Identity usert PasswordHash = NULL-lal, mert azzal nem lehet belépni. A helyes út: UserManager.CreateAsync(...) / ResetPasswordAsync(...).

-- 5) DocumentTypes seed (üzleti seed) – jelenlegi állapot

-- A DocumentTypes seeding jelenleg külön try/catch-ben a végén fut, hogy ne blokkolja a belépést, mert a DB-ben oszlopnév eltérés van (Invalid column name 'Name').

-- Mit jelent ez?

-- Identity seed (belépés) működik

-- DocumentTypes seed hibája csak logba kerül

-- később külön javítandó a mapping / migráció

-- 6) Alkalmazás indítása
-- 6.1. Futtatás

-- Visual Studio: Run

-- CLI: dotnet run

-- Indításkor történik:

-- DB migráció

-- Roles seed

-- Admin userek seed

-- (opcionális) DocumentTypes seed (jelenleg hibát elnyeli)

-- 7) Első belépés
-- 7.1. Login oldal

-- Az Identity UI login URL-je:

-- /Identity/Account/Login

-- 7.2. Bejelentkezési adatok

-- SuperAdmin:

-- Email: superadmin@example.com

-- Jelszó: SuperAdmin@123 (ha nincs felülírva SeedAdminPasswords-ben)

-- Admin:

-- Email: admin@example.com

-- Jelszó: Admin@123 (ha nincs felülírva)

-- Gyakori hibák és gyors diagnózis
-- A) “Invalid login attempt” + üres AspNetUsers

-- Ok: seed nem futott le vagy elhasalt.

-- Ellenőrzés:

-- SELECT COUNT(*) FROM dbo.AspNetUsers;
-- SELECT COUNT(*) FROM dbo.AspNetRoles;


-- Ha 0-0:

-- seeding valószínűleg exceptiont dobott

-- ellenőrizd a startup logot

-- B) Layout NullReference bejelentkezés előtt

-- A _Layout.cshtml-ben a currentUser null lehet (anonim oldalakon). Fix:

-- currentUserName = currentUser?.UserName ?? ""

-- otherUsers legyen mindig inicializálva vagy ?? Enumerable.Empty<>()

-- C) DbUpdateException: “Invalid column name 'Name'”

-- Ok: a DB-ben a DocumentTypes táblában nincs Name oszlop (model–schema mismatch).
-- Megoldás: később mapping vagy migráció:

-- SQL: INFORMATION_SCHEMA.COLUMNS alapján kideríteni a valós oszlopnevet

-- Entity [Column("...")] vagy Fluent .HasColumnName("...")

-- vagy migrációval létrehozni a Name oszlopot

-- D) Dupla AddDbContext

-- Ha kétszer van regisztrálva AddDbContext<ApplicationDbContext>, random viselkedés lehet.
-- Szabály: csak egy AddDbContext legyen.

-- Ajánlott “átadási” megjegyzések (best practice)

-- Telepítés = Migrate + Seed (nem DBCC clone)

-- Seed legyen idempotens (IF NOT EXISTS logika)

-- Identity usert soha ne SQL-ből jelszó nélkül (PasswordHash null)

-- Üzleti seed (pl. DocumentTypes) ne blokkolja a belépést → külön try/catch vagy külön “bootstrap” lépés

-- Titkok kezelése: ENV / user-secrets / vault, ne gitben.



db migráció

Identity visszaállítása (nagyon fontos)

Hogy a PartnerId újra 1-től induljon:

DBCC CHECKIDENT ('dbo.Partners', RESEED, 0);
GO


(Ajánlott) Sites identity nullázása is

Mivel a következő lépés a partner → sites újramigrálás, itt is tiszta lappal jobb:

DBCC CHECKIDENT ('dbo.Sites', RESEED, 0);
GO



PartnerId fordítókulcs tábla létrehozása

USE Cloud9_Nyugalom;
GO

IF OBJECT_ID('dbo.PartnerId_Map', 'U') IS NOT NULL
    DROP TABLE dbo.PartnerId_Map;
GO

-- 1) Táblát explicit típusokkal hozzuk létre
CREATE TABLE dbo.PartnerId_Map
(
    OldPartnerId INT NOT NULL,
    NewPartnerId INT NOT NULL
);
GO

-- 2) Feltöltés: OwnId -> OldPartnerId (csak ami intté konvertálható)
INSERT INTO dbo.PartnerId_Map (OldPartnerId, NewPartnerId)
SELECT
    TRY_CONVERT(INT, p.OwnId) AS OldPartnerId,
    p.PartnerId               AS NewPartnerId
FROM dbo.Partners p
WHERE TRY_CONVERT(INT, p.OwnId) IS NOT NULL;
GO

-- 3) Indexek / unique constraint
CREATE UNIQUE INDEX IX_PartnerId_Map_OldPartnerId
ON dbo.PartnerId_Map(OldPartnerId);
GO

CREATE UNIQUE INDEX IX_PartnerId_Map_NewPartnerId
ON dbo.PartnerId_Map(NewPartnerId);
GO




Partner migráció INSERT (T-SQL)

Ez feltételezi, hogy a célban a Partners tábla most üres (vagy előtte törölted), és a Currencies már megvan.

USE Cloud9_Nyugalom;
GO

INSERT INTO dbo.Partners
(
    Name,
    Email,
    PartnerCode,
    OwnId,
    PhoneNumber,
    AlternatePhone,
    Website,
    GFOId,
    PreferredCurrency,
    Notes,
    Comment1,
    Comment2,
    CreatedDate,
    CreatedBy,
    IsActive
)
SELECT
    p.Nev                                  AS Name,
    p.Email1                               AS Email,
    p.PartnerKod                           AS PartnerCode,
    CAST(p.PartnerId AS NVARCHAR(50))      AS OwnId,          -- <- így biztosan befér, bármilyen OwnId típus esetén
    p.Telefon1                             AS PhoneNumber,
    p.Telefon2                             AS AlternatePhone,
    p.Honlap                               AS Website,
    p.BusinessFormId                       AS GFOId,
    p.AppropriationCurrencyId              AS PreferredCurrency,
    p.SajatAzonosito                       AS Notes,          -- <- kérésed szerint
    p.Megjegyzes                           AS Comment1,
    NULL                                   AS Comment2,
    p.CreationDate                         AS CreatedDate,
    'superadmin@example.com'               AS CreatedBy,
    CASE WHEN p.Aktiv = 1 THEN 1 ELSE 0 END AS IsActive
FROM iWiseDb_DEV.dbo.Partner p;
GO



Konkrét UPDATE (TaxId + IntTaxId + a kért mezők)

Ez frissíti a már bent lévő partnereket a forrásból, OwnId = régi PartnerId párosítással:

USE Cloud9_Nyugalom;
GO

UPDATE tgt
SET
    tgt.CreatedDate        = src.CreationDate,
    tgt.PartnerCode        = src.PartnerKod,
    tgt.Name               = src.Nev,
    tgt.GFOId              = src.BusinessFormId,
    tgt.PhoneNumber        = src.Telefon1,
    tgt.AlternatePhone     = src.Telefon2,
    tgt.Email              = src.Email1,
    tgt.BillingEmail       = src.Email2,
    tgt.Website            = src.Honlap,
    tgt.IsActive           = CASE WHEN src.Aktiv = 1 THEN 1 ELSE 0 END,
    tgt.Comment1           = src.Megjegyzes,
    tgt.Notes              = src.SajatAzonosito,
    tgt.PreferredCurrency  = src.AppropriationCurrencyId,
    tgt.TaxId              = sa.Adoszam,
    tgt.IntTaxId           = sa.EUAdoszam,
    tgt.UpdatedDate        = SYSUTCDATETIME(),
    tgt.UpdatedBy          = 'superadmin@example.com'
FROM dbo.Partners tgt
JOIN iWiseDb_DEV.dbo.Partner src
  ON TRY_CONVERT(int, tgt.OwnId) = src.PartnerId
LEFT JOIN iWiseDb_DEV.dbo.SzamlazasiAdatok sa
  ON sa.SzamlazasiAdatokId = src.SzamlazasiAdatokId;
GO




UPDATE Partners cím + adószám + többi mező (OwnId alapján)
USE Cloud9_Nyugalom;
GO

UPDATE tgt
SET
    tgt.CreatedDate        = src.CreationDate,
    tgt.PartnerCode        = src.PartnerKod,
    tgt.Name               = src.Nev,
    tgt.GFOId              = src.BusinessFormId,
    tgt.PhoneNumber        = src.Telefon1,
    tgt.AlternatePhone     = src.Telefon2,
    tgt.Email              = src.Email1,
    tgt.BillingEmail       = src.Email2,
    tgt.Website            = src.Honlap,
    tgt.IsActive           = CASE WHEN src.Aktiv = 1 THEN 1 ELSE 0 END,
    tgt.Comment1           = src.Megjegyzes,
    tgt.Notes              = src.SajatAzonosito,
    tgt.PreferredCurrency  = src.AppropriationCurrencyId,

    tgt.TaxId              = sa.Adoszam,
    tgt.IntTaxId           = sa.EUAdoszam,

    tgt.AddressLine1       = ca.Kozterulet,
    tgt.AddressLine2       = COALESCE(tgt.AddressLine2, ''),  -- ha legyen mindig non-null
    tgt.City               = ca.Varos,
    tgt.PostalCode         = ca.Iranyitoszam,
    tgt.Country            = ca.Orszag,
    tgt.State              = NULL,

    tgt.UpdatedDate        = SYSUTCDATETIME(),
    tgt.UpdatedBy          = 'superadmin@example.com'
FROM dbo.Partners tgt
JOIN iWiseDb_DEV.dbo.Partner src
  ON TRY_CONVERT(int, tgt.OwnId) = src.PartnerId
LEFT JOIN iWiseDb_DEV.dbo.SzamlazasiAdatok sa
  ON sa.SzamlazasiAdatokId = src.SzamlazasiAdatokId
LEFT JOIN iWiseDb_DEV.dbo.SzamlazasiAdatokCim sac
  ON sac.SzamlazasiAdatokCimId = sa.SzamlazasiAdatokCimId
LEFT JOIN iWiseDb_DEV.dbo.CimAdat ca
  ON ca.CimAdatId = sac.CimAdatId;
GO



PartnerId_Map újragenerálása (robosztusan)
USE Cloud9_Nyugalom;
GO

IF OBJECT_ID('dbo.PartnerId_Map', 'U') IS NOT NULL
  DROP TABLE dbo.PartnerId_Map;
GO

CREATE TABLE dbo.PartnerId_Map
(
  OldPartnerId INT NOT NULL,
  NewPartnerId INT NOT NULL
);
GO

INSERT INTO dbo.PartnerId_Map (OldPartnerId, NewPartnerId)
SELECT
  TRY_CONVERT(int, p.OwnId) AS OldPartnerId,
  p.PartnerId               AS NewPartnerId
FROM dbo.Partners p
WHERE TRY_CONVERT(int, p.OwnId) IS NOT NULL;
GO

CREATE UNIQUE INDEX IX_PartnerId_Map_Old ON dbo.PartnerId_Map(OldPartnerId);
CREATE UNIQUE INDEX IX_PartnerId_Map_New ON dbo.PartnerId_Map(NewPartnerId);
GO





Javított Sites INSERT (CreatedById = NULL)

Ezt futtasd:

USE Cloud9_Nyugalom;
GO

DELETE FROM dbo.Sites;
GO
DBCC CHECKIDENT ('dbo.Sites', RESEED, 0);
GO

INSERT INTO dbo.Sites
(
    SiteName, AddressLine1, AddressLine2, City, State, PostalCode, Country,
    IsPrimary, CreatedDate, CreatedById,
    PartnerId, StatusId,
    ContactPerson1, ContactPerson2, ContactPerson3,
    Phone1, Phone2, Phone3,
    MobilePhone1, MobilePhone2, MobilePhone3,
    messagingApp1, messagingApp2, messagingApp3,
    eMail1, eMail2,
    Comment1, Comment2,
    IsActive, SiteTypeId
)
SELECT
    t.Nev,
    ca.Kozterulet,
    '' AS AddressLine2,
    ca.Varos,
    NULL AS State,
    ca.Iranyitoszam,
    ca.Orszag,

    0 AS IsPrimary,
    SYSUTCDATETIME() AS CreatedDate,
    NULL AS CreatedById,                 -- ✅ FK miatt

    pm.NewPartnerId AS PartnerId,
    8 AS StatusId,

    NULL, NULL, NULL,
    t.Telefon AS Phone1, NULL, NULL,
    NULL, NULL, NULL,
    NULL, NULL,
    CAST(t.TelephelyId AS nvarchar(50)) AS messagingApp3,
    t.Email AS eMail1,
    NULL AS eMail2,
    t.Megjegyzes AS Comment1,
    NULL AS Comment2,
    1 AS IsActive,
    4 AS SiteTypeId
FROM iWiseDb_DEV.dbo.PartnerTelephely pt
JOIN iWiseDb_DEV.dbo.Telephely t
  ON t.TelephelyId = pt.TelephelyId
LEFT JOIN iWiseDb_DEV.dbo.TelephelyCim tc
  ON tc.TelephelyCimId = t.TelephelyCimId
LEFT JOIN iWiseDb_DEV.dbo.CimAdat ca
  ON ca.CimAdatId = tc.CimAdatId
JOIN dbo.PartnerId_Map pm
  ON pm.OldPartnerId = pt.PartnerId;
GO



USE Cloud9_Nyugalom;
GO

IF OBJECT_ID('dbo.TelephelyId_Map', 'U') IS NOT NULL
    DROP TABLE dbo.TelephelyId_Map;
GO

CREATE TABLE dbo.TelephelyId_Map
(
  OldTelephelyId INT NOT NULL,
  NewSiteId      INT NOT NULL
);

INSERT INTO dbo.TelephelyId_Map (OldTelephelyId, NewSiteId)
SELECT
  t.TelephelyId,
  s.SiteId
FROM iWiseDb_DEV.dbo.Telephely t
JOIN dbo.Sites s
  ON TRY_CONVERT(int, s.messagingApp3) = t.TelephelyId;

CREATE UNIQUE INDEX IX_TelephelyId_Map_Old ON dbo.TelephelyId_Map(OldTelephelyId);
CREATE UNIQUE INDEX IX_TelephelyId_Map_New ON dbo.TelephelyId_Map(NewSiteId);
GO





USE Cloud9_Nyugalom;
GO

IF OBJECT_ID('dbo.IncidentType_To_ComMethod_Map', 'U') IS NOT NULL
    DROP TABLE dbo.IncidentType_To_ComMethod_Map;
GO

CREATE TABLE dbo.IncidentType_To_ComMethod_Map
(
    OldIncidentTypeId   INT NOT NULL PRIMARY KEY,
    TaskPMcomMethodID   INT NOT NULL
);
GO

-- Feltételezés: 1..4 megfeleltetés így van értelmezve nálatok
INSERT INTO dbo.IncidentType_To_ComMethod_Map (OldIncidentTypeId, TaskPMcomMethodID)
VALUES
(1, 1), -- Telefon
(2, 2), -- Email
(3, 3), -- Személyes
(4, 4); -- Alarmsys
GO




